<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hearts2Hearts: Bias Edition</title>
<link rel="icon" type="image/png" href="assets/fav.png">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
:root{
    --main:#7FB3D5; /* Default (Bisa berubah) */
    --p2-color: #FFB7B2;
    --text:#555;
    --bg-overlay: rgba(255,255,255,0.92);
}

*{box-sizing:border-box;}
body,html{ margin:0; padding:0; width:100%; height:100%; font-family:'Quicksand',sans-serif; overflow:hidden; color:var(--text); background:#fff; transition: 0.5s; }

/* OVERLAY & PATTERN */
.overlay{
    position:fixed; inset:0; display:flex; justify-content:center; align-items:center;
    flex-direction:column; text-align:center; z-index:100;
    background: linear-gradient(#e9f3f9 1px, transparent 1px), linear-gradient(90deg,#e9f3f9 1px,transparent 1px);
    background-size:40px 40px; background-color: var(--bg-overlay);
}
#logo-pattern{ position:absolute; inset:0; z-index:-1; pointer-events:none; opacity:.25; }
.logo-item{ position:absolute; opacity:.6; }

/* CANVAS */
canvas{ width:100vw; height:100vh; object-fit:cover; display:block; }

/* UI BOX */
.start-ui{
    display:flex; flex-direction:column; gap:15px; align-items:center;
    max-width:500px; width:95%; padding:25px;
    background: #fff; border-radius: 35px; border: 4px solid var(--main);
    box-shadow: 0 15px 40px rgba(0,0,0,0.1); transition: 0.3s;
}

.label{ font-weight:bold; letter-spacing:1px; color:#888; font-size:14px; text-transform: uppercase; }

/* MEMBER GRID (NEW) */
.member-grid {
    display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;
    width: 100%; margin-bottom: 10px;
}
.member-item {
    display: flex; flex-direction: column; align-items: center;
    cursor: pointer; padding: 8px; border-radius: 15px;
    border: 2px solid transparent; transition: 0.2s; background: #f9f9f9;
}
.member-item:hover { transform: translateY(-3px); background: #eee; }
.member-item.selected { border-color: var(--main); background: #fff5f5; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
.mem-emoji { font-size: 28px; line-height: 1; margin-bottom: 5px; }
.mem-name { font-size: 11px; font-weight: bold; color: #555; }

/* INPUTS */
input[type="number"]{
    width:100px; font-size:32px; text-align:center; border:2px solid var(--main);
    border-radius:14px; padding:5px; font-family:'Fredoka One'; color:var(--main); outline:none;
}
select{
    width:100%; padding:10px; border:2px solid #eee; border-radius:12px; outline:none;
}
.btn{
    width:100%; padding:15px; font-size:24px; font-family:'Fredoka One'; border-radius:20px;
    border:none; background:var(--main); color:#fff; cursor:pointer;
    box-shadow: 0 5px 0 rgba(0,0,0,0.1); transition: 0.2s;
}
.btn:hover{ transform: translateY(-2px); filter:brightness(1.1); }
.btn-photo { background: #FFB7B2; font-size: 18px; padding: 12px; margin-top: 5px; }

/* HUD & COUNTDOWN */
.hud{ position:absolute; top:20px; width:100%; display:flex; justify-content:space-around; pointer-events:none; z-index:20; opacity:0; transition: 0.5s; }
.score-box{ padding:10px 25px; border-radius:20px; background:rgba(255,255,255,0.95); border:3px solid var(--main); text-align:center; font-family:'Fredoka One'; color:var(--main); min-width: 90px; }
#countdown-ui{ position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-family:'Fredoka One'; font-size:120px; z-index:200; display:none; color:var(--main); text-shadow: 5px 5px 0 #fff; }

#game-over { display: none; }
</style>
</head>
<body>

<canvas id="output_canvas"></canvas>
<div id="countdown-ui">3</div>

<div id="start-menu" class="overlay">
    <div id="logo-pattern"></div>
    <div class="start-ui">
        <img src="assets/logo panjang.png" style="width:70%; margin-bottom: 5px;">
        
        <div class="label">Choose Your Bias</div>
        <div class="member-grid" id="member-container">
            </div>

        <div style="display:flex; gap:10px; width:100%; align-items:center; justify-content:center;">
            <div>
                <div class="label">GOAL</div>
                <input type="number" id="goal-input" value="10" min="1" max="99">
            </div>
            <div style="flex-grow:1;">
                <div class="label" style="text-align:left; margin-bottom:5px;">CAMERA</div>
                <select id="cam_select"><option disabled selected>Select Cam</option></select>
            </div>
        </div>
        
        <button class="btn" onclick="startGame()">PLAY GAME</button>
        <a href="photobox.html" style="text-decoration:none; width:100%;">
            <button class="btn btn-photo">üì∏ PHOTOBOX</button>
        </a>
    </div>
</div>

<div id="game-over" class="overlay">
    <div class="start-ui">
        <div class="label">WINNER</div>
        <h1 id="winner-name" style="font-family:'Fredoka One'; font-size: 40px; color: var(--main); margin: 10px 0;">PLAYER 1</h1>
        <div style="font-size: 60px;">üèÜ</div>
        <button class="btn" onclick="location.reload()">PLAY AGAIN</button>
    </div>
</div>

<div class="hud">
    <div class="score-box">
        <div style="font-size:12px;">P1</div>
        <div id="p1-score" style="font-size:32px;">0</div>
    </div>
    <div style="background:white; padding:5px 15px; border-radius:15px; height:fit-content; margin-top:10px; border:2px solid #eee;">
        <span style="font-size:10px; font-weight:bold; color:#aaa;">GOAL:</span>
        <span id="display-goal" style="font-weight:bold; color:#555;">10</span>
    </div>
    <div class="score-box" style="border-color: var(--p2-color); color: var(--p2-color);">
        <div style="font-size:12px;">P2</div>
        <div id="p2-score" style="font-size:32px;">0</div>
    </div>
</div>

<video id="input_video" style="display:none"></video>

<script>
/* ================= DATA MEMBER H2H ================= */
const members = [
    { id: 'jiwoo', name: 'Jiwoo', emoji: 'üçì', color: '#ff5c8a' },
    { id: 'carmen', name: 'Carmen', emoji: 'üå¥', color: '#4caf50' },
    { id: 'yuha', name: 'Yuha', emoji: 'üéÄ', color: '#ff9ebb' },
    { id: 'stella', name: 'Stella', emoji: 'üßÅ', color: '#00d2ff' }, // Pake biru terang biar kontras
    { id: 'juun', name: 'Juun', emoji: 'üëæ', color: '#9c27b0' },
    { id: 'ian', name: 'Ian', emoji: 'ü´õ', color: '#8bc34a' },
    { id: 'ana', name: 'A-Na', emoji: 'üåª', color: '#ffc107' },
    { id: 'yeon', name: 'Ye-on', emoji: 'üòä', color: '#ff9800' }
];

let selectedMember = members[0]; // Default Jiwoo

/* ================= INIT UI ================= */
function initMemberGrid() {
    const container = document.getElementById('member-container');
    members.forEach((m, index) => {
        const div = document.createElement('div');
        div.className = `member-item ${index === 0 ? 'selected' : ''}`;
        div.onclick = () => selectMember(m, div);
        div.innerHTML = `<div class="mem-emoji">${m.emoji}</div><div class="mem-name">${m.name}</div>`;
        container.appendChild(div);
    });
}

function selectMember(member, element) {
    selectedMember = member;
    // Update Visual Selection
    document.querySelectorAll('.member-item').forEach(el => el.classList.remove('selected'));
    element.classList.add('selected');
    
    // Update Theme Color
    document.documentElement.style.setProperty('--main', member.color);
}
initMemberGrid();

// Pattern BG
const patternSrc = 'assets/fav.png';
const customLoveImg = new Image(); customLoveImg.src = patternSrc;

function createLogoPattern(){
    const container = document.getElementById('logo-pattern');
    for(let i=0; i<30; i++){
        let size = Math.random()*50+20;
        let img = document.createElement('img'); img.src = patternSrc; img.className = 'logo-item';
        img.style.top = Math.random()*100+'%'; img.style.left = Math.random()*100+'%';
        img.style.width = size+'px';
        img.style.transform = `translate(-50%,-50%) rotate(${Math.random()*360}deg)`;
        container.appendChild(img);
    }
}
createLogoPattern();

/* ================= GAME VARS ================= */
const sfxSlice = new Audio('assets/slice.mp3'); 
const sfxStart = new Audio('assets/game-start.mp3'); 
const sfxOver = new Audio('assets/game-over.mp3');
let scores={p1:0,p2:0}, winScore=10, isRunning=false, gameActive=false;
let hands, camera, canvasCtx, canvasElement;
let targets=[], particles=[], loveParticles=[];
let trailHistory={p1:[],p2:[]};
let smoothPos={p1:{x:0,y:0,active:false},p2:{x:0,y:0,active:false}};
let lastLoveTrigger=0, lastTwoHandTrigger=0;

/* ================= SETUP ================= */
function init(){
    canvasElement = document.getElementById('output_canvas');
    canvasCtx = canvasElement.getContext('2d');
    hands = new Hands({locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
    hands.setOptions({maxNumHands:2, modelComplexity:1, minDetectionConfidence:0.5, minTrackingConfidence:0.5});
    hands.onResults(onResults);
    navigator.mediaDevices.enumerateDevices().then(devices=>{
        devices.filter(d=>d.kind==='videoinput').forEach(d=>{
            $('#cam_select').append(`<option value="${d.deviceId}">${d.label||'Cam'}</option>`);
        });
    });
}

function createTarget(side) {
    const minX = side===0?0.05:0.55; const maxX = side===0?0.45:0.95;
    return {
        baseX:Math.random()*(maxX-minX)+minX, baseY:Math.random()*0.6+0.2, side:side,
        r:35, color:side===0?selectedMember.color:'#FFB7B2', // P1 ikut warna member
        phase:Math.random()*10, speed:0.02+Math.random()*0.03, active:true
    };
}

function startGame(){
    winScore=parseInt($('#goal-input').val())||10;
    $('#display-goal').text(winScore);
    scores={p1:0,p2:0}; $('#p1-score').text(0); $('#p2-score').text(0);
    targets=[]; particles=[]; loveParticles=[];
    
    $('#start-menu').fadeOut(400); $('.hud').css('opacity','1');
    camera = new Camera(document.getElementById('input_video'), {
        onFrame: async()=>{if(isRunning)await hands.send({image:input_video});},
        width:1280, height:720, deviceId:$('#cam_select').val()
    });
    camera.start(); isRunning=true; sfxStart.play();
    
    let count=3; $('#countdown-ui').show().text(count);
    const t=setInterval(()=>{
        count--; if(count>0)$('#countdown-ui').text(count);
        else{
            clearInterval(t); $('#countdown-ui').fadeOut();
            for(let i=0;i<winScore+4;i++){ targets.push(createTarget(0)); targets.push(createTarget(1)); }
            gameActive=true;
        }
    },1000);
}

// --- PARTIKEL CINTA & EMOJI ---
function spawnLove(x, y, amount=4, sizeBase=30) {
    const now=Date.now(); if(now-lastLoveTrigger<150)return; lastLoveTrigger=now;
    for(let i=0;i<amount;i++){
        loveParticles.push({
            x:x, y:y, vx:(Math.random()-0.5)*5, vy:-Math.random()*5-3, life:1.0,
            size:Math.random()*sizeBase+sizeBase, rotation:(Math.random()-0.5)*0.5,
            // 50% Kemungkinan muncul Emoji Member, 50% Logo H2H
            type: Math.random() > 0.5 ? 'emoji' : 'logo'
        });
    }
}

function drawHeartShape(ctx,x,y,size,color){
    ctx.save(); ctx.translate(x,y); ctx.beginPath();
    ctx.moveTo(0,-size/2); ctx.bezierCurveTo(size/2,-size,size,-size/3,0,size); 
    ctx.bezierCurveTo(-size,-size/3,-size/2,-size,0,-size/2); 
    ctx.fillStyle=color; ctx.shadowBlur=15; ctx.shadowColor=color; ctx.fill();
    ctx.strokeStyle="white"; ctx.lineWidth=3; ctx.stroke(); ctx.restore();
}

/* ================= RENDER LOOP ================= */
function onResults(results){
    canvasElement.width=innerWidth; canvasElement.height=innerHeight;
    canvasCtx.clearRect(0,0,innerWidth,innerHeight);
    canvasCtx.drawImage(results.image,0,0,innerWidth,innerHeight);

    // Update Particles
    for(let i=particles.length-1;i>=0;i--){
        let p=particles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.04;
        if(p.life<=0)particles.splice(i,1);
        else{
            canvasCtx.globalAlpha=p.life; canvasCtx.fillStyle=p.color;
            canvasCtx.beginPath(); canvasCtx.arc(p.x,p.y,p.size,0,Math.PI*2); canvasCtx.fill();
        }
    }
    
    // Update Love/Emoji
    canvasCtx.globalAlpha=1.0;
    for(let i=loveParticles.length-1;i>=0;i--){
        let p=loveParticles[i]; p.x+=p.vx; p.y+=p.vy; p.life-=0.02;
        if(p.life<=0)loveParticles.splice(i,1);
        else{
            canvasCtx.save(); canvasCtx.translate(p.x,p.y);
            canvasCtx.rotate(p.rotation); canvasCtx.globalAlpha=p.life;
            
            if(p.type === 'logo') {
                canvasCtx.drawImage(customLoveImg,-p.size/2,-p.size/2,p.size,p.size);
            } else {
                // Render Emoji Bias
                canvasCtx.font = `${p.size}px Arial`;
                canvasCtx.textAlign = "center";
                canvasCtx.textBaseline = "middle";
                canvasCtx.fillText(selectedMember.emoji, 0, 0);
            }
            canvasCtx.restore();
        }
    }
    canvasCtx.globalAlpha=1.0;

    // Hand Logic
    let detectedP1=false, detectedP2=false;
    
    // Two Hand
    if(results.multiHandLandmarks && results.multiHandLandmarks.length===2){
        const h1=results.multiHandLandmarks[0], h2=results.multiHandLandmarks[1];
        if(Math.hypot(h1[8].x-h2[8].x, h1[8].y-h2[8].y)<0.1 && Math.hypot(h1[4].x-h2[4].x, h1[4].y-h2[4].y)<0.15){
            if(Date.now()-lastTwoHandTrigger>800){
                lastTwoHandTrigger=Date.now();
                spawnLove(((h1[8].x+h2[8].x)/2)*innerWidth, ((h1[4].y+h2[4].y)/2)*innerHeight, 15, 60);
            }
        }
    }

    if(results.multiHandLandmarks){
        results.multiHandLandmarks.forEach(lm=>{
            const isP1=lm[9].x<0.5; const pKey=isP1?'p1':'p2';
            // Warna Trail P1 mengikuti Member, P2 default Pink
            const themeColor=isP1?selectedMember.color:'#FFB7B2';
            if(isP1)detectedP1=true; else detectedP2=true;
            
            const rawX=lm[8].x*innerWidth, rawY=lm[8].y*innerHeight;
            
            // Finger Heart
            if(Math.hypot(lm[4].x-lm[8].x, lm[4].y-lm[8].y)<0.05){
                spawnLove((lm[4].x+lm[8].x)/2*innerWidth, (lm[4].y+lm[8].y)/2*innerHeight);
            }

            if(!smoothPos[pKey].active){smoothPos[pKey].x=rawX;smoothPos[pKey].y=rawY;smoothPos[pKey].active=true;}
            else{smoothPos[pKey].x+=(rawX-smoothPos[pKey].x)*0.3; smoothPos[pKey].y+=(rawY-smoothPos[pKey].y)*0.3;}
            const fx=smoothPos[pKey].x, fy=smoothPos[pKey].y;

            trailHistory[pKey].push({x:fx,y:fy}); if(trailHistory[pKey].length>15)trailHistory[pKey].shift();
            if(trailHistory[pKey].length>2){
                canvasCtx.beginPath(); canvasCtx.lineWidth=12; canvasCtx.lineCap='round'; canvasCtx.strokeStyle=themeColor;
                canvasCtx.shadowColor="white"; canvasCtx.shadowBlur=10;
                canvasCtx.moveTo(trailHistory[pKey][0].x,trailHistory[pKey][0].y);
                for(let i=1;i<trailHistory[pKey].length;i++){
                    const xc=(trailHistory[pKey][i].x+trailHistory[pKey][i-1].x)/2;
                    const yc=(trailHistory[pKey][i].y+trailHistory[pKey][i-1].y)/2;
                    canvasCtx.quadraticCurveTo(trailHistory[pKey][i-1].x,trailHistory[pKey][i-1].y,xc,yc);
                }
                canvasCtx.lineTo(fx,fy); canvasCtx.stroke(); canvasCtx.shadowBlur=0;
            }
            canvasCtx.beginPath(); canvasCtx.arc(fx,fy,10,0,Math.PI*2); canvasCtx.fillStyle="#fff"; canvasCtx.fill();
            canvasCtx.lineWidth=3; canvasCtx.strokeStyle=themeColor; canvasCtx.stroke();

            if(gameActive){
                targets.forEach(t=>{
                    if(!t.active)return;
                    const tx=(t.baseX+Math.sin(t.phase)*0.1)*innerWidth, ty=(t.baseY+Math.cos(t.phase)*0.1)*innerHeight;
                    if(Math.hypot(fx-tx,fy-ty)<t.r+30){
                        if((t.side===0&&isP1)||(t.side===1&&!isP1)){
                            for(let k=0;k<8;k++)particles.push({x:tx,y:ty,vx:(Math.random()-0.5)*10,vy:(Math.random()-0.5)*10,life:1,color:t.color,size:Math.random()*5+3});
                            sfxSlice.play(); t.active=false;
                            if(t.side===0){scores.p1++;$('#p1-score').text(scores.p1);}else{scores.p2++;$('#p2-score').text(scores.p2);}
                            if((scores.p1>=winScore||scores.p2>=winScore)&&gameActive){
                                gameActive=false; sfxOver.play();
                                $('#winner-name').text(scores.p1>=winScore?"PLAYER 1":"PLAYER 2").css('color',scores.p1>=winScore?selectedMember.color:'#FFB7B2');
                                $('#game-over').fadeIn(500).css('display','flex');
                            }
                        }
                    }
                });
            }
        });
    }
    if(!detectedP1){smoothPos.p1.active=false;trailHistory.p1=[];}
    if(!detectedP2){smoothPos.p2.active=false;trailHistory.p2=[];}
    if(gameActive){
        targets.forEach(t=>{
            if(!t.active)return; t.phase+=t.speed;
            drawHeartShape(canvasCtx, (t.baseX+Math.sin(t.phase)*0.1)*innerWidth, (t.baseY+Math.cos(t.phase)*0.1)*innerHeight, t.r, t.color);
        });
    }
}
init();
</script>
</body>
</html>
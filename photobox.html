<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H2H: Kiyowo Photobox</title>
<link rel="icon" type="image/png" href="assets/fav.png">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
    /* Default Var */
    :root { --main: #FFB7B2; --bg: #FFF0F5; }
    
    body { 
        margin: 0; padding: 20px; background: var(--bg); 
        font-family: 'Quicksand', sans-serif; color: #555;
        display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        transition: background 0.5s;
    }

    /* --- UI Container --- */
    .container {
        max-width: 700px; width: 100%; text-align: center;
        background: rgba(255, 255, 255, 0.95); padding: 30px; border-radius: 40px;
        border: 4px solid var(--main);
        box-shadow: 10px 10px 0 rgba(0,0,0,0.1);
        transition: border 0.5s;
    }

    h1 { font-family: 'Fredoka One'; color: var(--main); font-size: 2.5rem; margin: 0 0 10px 0; }
    p.subtitle { margin-bottom: 25px; color: #777; font-weight: bold; }

    /* --- Style Selector --- */
    .style-grid { display: flex; gap: 15px; justify-content: center; flex-wrap: wrap; margin-bottom: 20px; }
    
    .style-card {
        width: 140px; padding: 15px; border-radius: 20px;
        cursor: pointer; border: 3px solid transparent;
        background: #f9f9f9; transition: 0.3s;
        display: flex; flex-direction: column; align-items: center; gap: 10px;
    }
    .style-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
    .style-card.selected { border-color: var(--main); background: #fff; box-shadow: 0 0 0 4px rgba(0,0,0,0.05); }

    .color-preview { width: 50px; height: 50px; border-radius: 50%; box-shadow: inset 0 0 10px rgba(0,0,0,0.1); }
    .style-name { font-weight: bold; font-size: 0.9rem; font-family: 'Fredoka One'; color: #555; }

    /* --- Camera Preview --- */
    .cam-frame {
        position: relative; width: 100%; aspect-ratio: 4/3; 
        border-radius: 20px; overflow: hidden; background: #000;
        border: 4px solid #eee; margin-bottom: 20px;
    }
    
    video { width: 100%; height: 100%; object-fit: cover; }
    
    #countdown {
        position: absolute; inset: 0; display: none;
        justify-content: center; align-items: center;
        font-family: 'Fredoka One'; font-size: 8rem; color: white;
        text-shadow: 4px 4px 0 var(--main);
        background: rgba(0,0,0,0.2);
    }

    #flash { position: fixed; inset: 0; background: white; z-index: 999; display: none; pointer-events: none; }

    /* --- Controls --- */
    .controls { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    button {
        padding: 15px 30px; border-radius: 50px; border: none;
        font-family: 'Fredoka One'; font-size: 1.2rem; cursor: pointer;
        transition: 0.2s; box-shadow: 0 5px 0 rgba(0,0,0,0.1);
    }
    .btn-main { background: var(--main); color: white; }
    .btn-main:hover { transform: translateY(-3px); filter: brightness(1.1); }
    .btn-sec { background: #eee; color: #777; }

    /* --- Result Area --- */
    #result-area { display: none; flex-direction: column; align-items: center; }
    #final-image { 
        max-width: 100%; border-radius: 10px; 
        box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        border: 2px dashed var(--main); margin-bottom: 20px;
    }

    /* Sections Visibility */
    #camera-section, #result-area { display: none; }
    #style-section { display: block; }
</style>
</head>
<body>

<div id="flash"></div>

<div class="container">
    <h1>H2H <span>Photobox</span> üì∏</h1>
    
    <div id="style-section">
        <p class="subtitle">‚ú® CHOOSE YOUR VIBE ‚ú®</p>
        <div class="style-grid">
            <div class="style-card" onclick="selectStyle('pastel')">
                <div class="color-preview" style="background: linear-gradient(135deg, #fff1eb, #ace0f9);"></div>
                <div class="style-name">Pastel Crush üå∏</div>
            </div>
            <div class="style-card" onclick="selectStyle('fresh')">
                <div class="color-preview" style="background: linear-gradient(135deg, #fdfbfb, #d4fc79);"></div>
                <div class="style-name">Fresh Lemon üçã</div>
            </div>
            <div class="style-card" onclick="selectStyle('dream')">
                <div class="color-preview" style="background: linear-gradient(135deg, #e0c3fc, #8ec5fc);"></div>
                <div class="style-name">Purple Dream üíú</div>
            </div>
        </div>
        <button class="btn-sec" onclick="location.href='index.html'">‚¨Ö HOME</button>
    </div>

    <div id="camera-section">
        <div class="cam-frame">
            <video id="video" autoplay playsinline></video>
            <div id="countdown">3</div>
        </div>
        <div class="controls">
            <button class="btn-sec" onclick="resetToStyle()">‚¨Ö BACK</button>
            <button class="btn-main" onclick="startPhotoSession()">START ‚ú®</button>
        </div>
    </div>

    <div id="result-area">
        <p class="subtitle">‚ú® SO KIYOWO! ‚ú®</p>
        <img id="final-image" src="" alt="Result">
        <div class="controls">
            <button class="btn-sec" onclick="location.reload()">RETAKE üîÑ</button>
            <button class="btn-main" onclick="downloadImage()">DOWNLOAD ‚¨á</button>
        </div>
    </div>
</div>

<canvas id="strip-canvas" style="display:none;"></canvas>

<script>
    // --- CONFIG & ASSETS ---
    const assets = {
        sticker: 'assets/fav.png',
        logo: 'assets/logo panjang.png', // Pake logo panjang di footer biar rapi
        sfxShutter: 'assets/slice.mp3',
        sfxCount: 'assets/game-start.mp3'
    };

    // --- STYLE CONFIGURATIONS ---
    const styles = {
        'pastel': {
            name: 'Pastel Crush',
            grad: ['#fff1eb', '#ace0f9'], // Pink to Blue
            mainColor: '#FFB7B2',
            frameColor: '#ffffff'
        },
        'fresh': {
            name: 'Fresh Lemon',
            grad: ['#fdfbfb', '#d4fc79'], // White to Lime
            mainColor: '#96e6a1',
            frameColor: '#fffee0'
        },
        'dream': {
            name: 'Purple Dream',
            grad: ['#fccb90', '#d57eeb'], // Peach to Purple
            mainColor: '#d57eeb',
            frameColor: '#f3e5f5'
        }
    };

    let currentStyle = 'pastel'; // Default
    let photos = [];
    const MAX_PHOTOS = 3;

    // --- DOM ELEMENTS ---
    const video = document.getElementById('video');
    const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
    const stripCanvas = document.getElementById('strip-canvas'); const stripCtx = stripCanvas.getContext('2d');
    const sfxShutter = new Audio(assets.sfxShutter);
    const sfxCount = new Audio(assets.sfxCount);
    
    // Images
    const stickerImg = new Image(); stickerImg.src = assets.sticker;
    const logoImg = new Image(); logoImg.src = assets.logo;

    // --- INIT CAMERA ---
    navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
        .then(stream => { video.srcObject = stream; })
        .catch(e => console.log("Cam error", e));

    // --- FUNCTIONS ---

    function selectStyle(key) {
        currentStyle = key;
        const s = styles[key];
        
        // Update UI Colors
        document.documentElement.style.setProperty('--main', s.mainColor);
        $('body').css('background', `linear-gradient(135deg, ${s.grad[0]}, ${s.grad[1]})`);
        
        // Highlight selection
        $('.style-card').removeClass('selected');
        // Simple visual feedback (opsional bisa tambah class specific)
        
        // Switch Screen
        $('#style-section').hide();
        $('#camera-section').fadeIn();
    }

    function resetToStyle() {
        $('#camera-section').hide();
        $('#style-section').fadeIn();
    }

    async function startPhotoSession() {
        $('.controls').hide(); // Hide buttons
        photos = [];
        
        for (let i = 1; i <= MAX_PHOTOS; i++) {
            await doCountdown(3);
            takeSnapshot();
            $('#flash').show().fadeOut(300);
            await new Promise(r => setTimeout(r, 1000));
        }

        renderResult();
    }

    function doCountdown(num) {
        return new Promise(resolve => {
            let c = num;
            $('#countdown').css('display','flex').text(c);
            let t = setInterval(() => {
                sfxCount.play();
                c--;
                if(c>0) $('#countdown').text(c);
                else { clearInterval(t); $('#countdown').hide(); resolve(); }
            }, 1000);
        });
    }

    function takeSnapshot() {
        sfxShutter.play();
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0);
        photos.push(canvas.toDataURL('image/png'));
    }

    // --- RENDERING LOGIC (THE MAGIC) ---
    function renderResult() {
        $('#camera-section').hide();
        $('#result-area').css('display','flex');

        const s = styles[currentStyle];
        
        // Config Ukuran
        const photoW = 400, photoH = 300; 
        const gap = 25, pad = 40, footerH = 140;
        const stripW = photoW + (pad*2);
        const stripH = pad + (MAX_PHOTOS * photoH) + ((MAX_PHOTOS-1)*gap) + footerH + pad;
        
        // Double Strip
        const totalW = (stripW * 2) + 20; 
        const totalH = stripH;

        stripCanvas.width = totalW; stripCanvas.height = totalH;

        // 1. Background Gradient
        const grad = stripCtx.createLinearGradient(0, 0, 0, totalH);
        grad.addColorStop(0, s.grad[0]);
        grad.addColorStop(1, s.grad[1]);
        stripCtx.fillStyle = grad;
        stripCtx.fillRect(0, 0, totalW, totalH);

        // 2. Random Sticker Overload (Background Layer)
        // Kita bikin BANYAK stiker (30 biji) tersebar
        function drawPattern(offsetX) {
            for(let i=0; i<30; i++) {
                const size = Math.random() * 50 + 20;
                const x = offsetX + Math.random() * stripW;
                const y = Math.random() * stripH;
                const rot = (Math.random()-0.5) * 2; // Rotasi acak

                stripCtx.save();
                stripCtx.translate(x, y);
                stripCtx.rotate(rot);
                stripCtx.globalAlpha = 0.4; // Transparan buat background
                stripCtx.drawImage(stickerImg, -size/2, -size/2, size, size);
                stripCtx.restore();
            }
        }
        drawPattern(0); // Kiri
        drawPattern(stripW+20); // Kanan

        // 3. Middle Line
        stripCtx.beginPath();
        stripCtx.setLineDash([15, 10]);
        stripCtx.moveTo(totalW/2, 0); stripCtx.lineTo(totalW/2, totalH);
        stripCtx.strokeStyle = "rgba(0,0,0,0.2)"; stripCtx.lineWidth = 2; stripCtx.stroke();
        stripCtx.setLineDash([]);

        // 4. Render Photos
        let loaded = 0;
        photos.forEach((src, idx) => {
            const img = new Image(); img.src = src;
            img.onload = () => {
                const y = pad + (idx * (photoH + gap));
                
                const drawPhoto = (offX) => {
                    // Shadow
                    stripCtx.fillStyle = "rgba(0,0,0,0.1)";
                    stripCtx.fillRect(offX+pad+6, y+6, photoW, photoH);
                    
                    // Frame (Warna ikut Style)
                    stripCtx.fillStyle = s.frameColor;
                    stripCtx.fillRect(offX+pad-10, y-10, photoW+20, photoH+20);
                    
                    // Photo
                    stripCtx.drawImage(img, offX+pad, y, photoW, photoH);

                    // Sticker Decoration (Corner) - Randomly appear on photos
                    if(Math.random() > 0.4) {
                        const sSize = 60;
                        // Random corner: TopLeft, TopRight, BottomLeft, BottomRight
                        const corner = Math.floor(Math.random()*4);
                        let sx, sy;
                        if(corner===0) { sx = offX+pad-20; sy = y-20; }
                        if(corner===1) { sx = offX+pad+photoW-40; sy = y-20; }
                        if(corner===2) { sx = offX+pad-20; sy = y+photoH-40; }
                        if(corner===3) { sx = offX+pad+photoW-40; sy = y+photoH-40; }

                        stripCtx.save();
                        stripCtx.translate(sx+30, sy+30);
                        stripCtx.rotate((Math.random()-0.5)*0.5);
                        stripCtx.globalAlpha = 1.0; // Solid
                        stripCtx.drawImage(stickerImg, -sSize/2, -sSize/2, sSize, sSize);
                        stripCtx.restore();
                    }
                };

                drawPhoto(0);
                drawPhoto(stripW+20);

                loaded++;
                if(loaded === MAX_PHOTOS) finalizeRender(stripW, stripH, footerH);
            };
        });
    }

    function finalizeRender(stripW, stripH, footerH) {
        // Render Footer Logo
        const logoW = 180;
        const logoH = logoW * (logoImg.height / logoImg.width);
        const ly = stripH - footerH + 30;

        stripCtx.globalAlpha = 1.0;
        // Kiri
        stripCtx.drawImage(logoImg, (stripW-logoW)/2, ly, logoW, logoH);
        // Kanan
        stripCtx.drawImage(logoImg, (stripW+20)+(stripW-logoW)/2, ly, logoW, logoH);

        // Display
        $('#final-image').attr('src', stripCanvas.toDataURL());
    }

    function downloadImage() {
        const a = document.createElement('a');
        a.download = `H2H-Kiyowo-${Date.now()}.png`;
        a.href = stripCanvas.toDataURL();
        a.click();
    }
</script>
</body>
</html>
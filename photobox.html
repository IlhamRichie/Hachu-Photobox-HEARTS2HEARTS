<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>H2H: Bias Photobox</title>
<link rel="icon" type="image/png" href="assets/fav.png">

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Fredoka+One&family=Quicksand:wght@500;700&display=swap" rel="stylesheet">

<style>
    /* --- CSS VARIABLES --- */
    :root {
        --theme-color: #ff5c8a;
        --theme-bg: #fff0f5;
        --theme-accent: #ff85a2;
    }

    /* --- BASIC SETUP --- */
    body {
        margin: 0; padding: 20px;
        background-color: var(--theme-bg);
        font-family: 'Quicksand', sans-serif;
        color: #444;
        display: flex; flex-direction: column; align-items: center; min-height: 100vh;
        transition: background-color 0.5s ease;
    }

    /* Background Pattern */
    body::before {
        content: ""; position: fixed; inset: 0; z-index: -1;
        background-image: radial-gradient(var(--theme-accent) 15%, transparent 16%);
        background-size: 30px 30px; opacity: 0.15;
    }

    /* --- MAIN CONTAINER --- */
    .app-container {
        max-width: 800px; width: 100%;
        background: rgba(255, 255, 255, 0.95);
        border: 5px solid var(--theme-color);
        border-radius: 40px;
        padding: 30px;
        box-shadow: 0 15px 40px rgba(0,0,0,0.1);
        transition: border-color 0.5s ease;
        text-align: center;
        position: relative;
        overflow: hidden;
    }

    h1 {
        font-family: 'Fredoka One'; font-size: clamp(2rem, 5vw, 3rem); 
        color: var(--theme-color); margin: 0 0 5px 0; letter-spacing: 1px;
    }
    p.sub { font-weight: bold; color: #888; margin-bottom: 25px; font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px;}

    /* --- GRID MEMBER --- */
    .member-grid {
        display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px; margin-bottom: 20px;
    }

    .member-card {
        background: #fff; border-radius: 20px; padding: 15px;
        cursor: pointer; border: 3px solid transparent;
        transition: all 0.3s;
        display: flex; flex-direction: column; align-items: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.05);
    }
    .member-card:hover { transform: translateY(-5px); }
    .member-card.active {
        border-color: var(--theme-color); background: var(--theme-bg);
        transform: scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    }
    .mem-emoji { font-size: 3rem; margin-bottom: 5px; filter: drop-shadow(0 3px 0 rgba(0,0,0,0.1)); }
    .mem-name { font-weight: bold; font-family: 'Fredoka One'; color: #555; }

    /* --- CAMERA --- */
    .cam-wrapper {
        position: relative; width: 100%; max-width: 500px; margin: 0 auto 20px;
        aspect-ratio: 4/3; border-radius: 25px; overflow: hidden;
        border: 5px solid var(--theme-color); background: #000;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    video { width: 100%; height: 100%; object-fit: cover; } 

    #countdown {
        position: absolute; inset: 0; display: none;
        justify-content: center; align-items: center;
        font-family: 'Fredoka One'; font-size: 8rem; color: #fff;
        text-shadow: 4px 4px 0 var(--theme-color);
        background: rgba(0,0,0,0.3); backdrop-filter: blur(2px);
    }

    /* --- BUTTONS --- */
    .btn-group { display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;}
    
    button {
        padding: 12px 25px; border-radius: 50px; border: none;
        font-family: 'Fredoka One'; font-size: 1.1rem; cursor: pointer;
        transition: 0.2s; box-shadow: 0 6px 0 rgba(0,0,0,0.1);
        text-transform: uppercase;
    }
    .btn-primary { background: var(--theme-color); color: white; }
    .btn-primary:hover { transform: translateY(-3px); filter: brightness(1.1); }
    .btn-secondary { background: #eee; color: #777; }
    .btn-secondary:hover { background: #ddd; }
    .btn-saweria { background: #faae2b; color: #543b1f; display: flex; align-items: center; gap: 8px; }
    .btn-saweria:hover { background: #ffc107; transform: translateY(-3px); }

    /* --- RESULT & HELPERS --- */
    #result-section { display: none; flex-direction: column; align-items: center; width: 100%; }
    
    #final-img {
        max-width: 100%; height: auto; border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        border: 4px solid #fff; margin-bottom: 20px;
        display: block;
        min-height: 200px; background: #eee; /* Placeholder bg */
    }

    #flash { position: fixed; inset: 0; background: white; z-index: 999; display: none; pointer-events: none; }
    
    /* Loading Overlay */
    #loading-overlay {
        position: absolute; inset: 0; background: rgba(255,255,255,0.8);
        display: none; justify-content: center; align-items: center;
        flex-direction: column; z-index: 50; font-family: 'Fredoka One';
        color: var(--theme-color); font-size: 1.5rem;
    }

    .hidden { display: none !important; }
    .footer-credit { margin-top: 20px; font-size: 12px; color: #888; font-weight: bold; }
    .footer-credit a { color: var(--theme-color); text-decoration: none; }
</style>
</head>
<body>

<div id="flash"></div>

<div class="app-container">
    <div id="loading-overlay">
        <span>‚ú® Processing...</span>
    </div>

    <h1>H2H <span>Photobox</span></h1>
    <p class="sub" id="subtitle">Select Your Bias to Start</p>

    <div id="select-section">
        <div class="member-grid" id="grid-container"></div>
        <button class="btn-secondary" onclick="location.href='index.html'" style="margin-top: 10px;">‚¨Ö Back to Game</button>
    </div>

    <div id="camera-section" class="hidden">
        <div class="cam-wrapper">
            <video id="video" autoplay playsinline></video>
            <div id="countdown">3</div>
        </div>
        <div class="btn-group" id="camera-btns">
            <button class="btn-secondary" onclick="resetApp()">Change Bias</button>
            <button class="btn-primary" onclick="startPhotoSession()">Take Photos üì∏</button>
        </div>
    </div>

    <div id="result-section">
        <img id="final-img" alt="Result will appear here">
        
        <div class="btn-group" id="result-btns">
            <button class="btn-secondary" onclick="location.reload()">Retake</button>
            <button class="btn-primary" onclick="printImage()" style="background-color: #333;">üñ®Ô∏è Print</button>
            <button class="btn-primary" onclick="downloadImage()">Download ‚¨á</button>
        </div>

        <div style="margin-top: 15px;">
            <a href="https://saweria.co/eloooyhm" target="_blank" style="text-decoration:none;">
                <button class="btn-saweria">üçï Traktir Jajan</button>
            </a>
        </div>
    </div>

    <div class="footer-credit">
        Made with üíñ by <a href="https://instagram.com/eloooyhm" target="_blank">@eloooyhm</a>
    </div>
</div>

<canvas id="render-canvas" style="display: none;"></canvas>

<script>
    // --- KONFIGURASI MEMBER ---
    const members = [
        { id: 'jiwoo', name: 'Jiwoo', emoji: 'üçì', color: '#ff5c8a', bg: '#fff0f5' },
        { id: 'carmen', name: 'Carmen', emoji: 'üå¥', color: '#4caf50', bg: '#e8f5e9' },
        { id: 'yuha', name: 'Yuha', emoji: 'üéÄ', color: '#ff9ebb', bg: '#fff0f6' },
        { id: 'stella', name: 'Stella', emoji: 'üßÅ', color: '#00d2ff', bg: '#e0f7fa' },
        { id: 'juun', name: 'Juun', emoji: 'üëæ', color: '#9c27b0', bg: '#f3e5f5' },
        { id: 'ian', name: 'Ian', emoji: 'üç´', color: '#8bc34a', bg: '#f1f8e9' },
        { id: 'ana', name: 'A-Na', emoji: 'üåª', color: '#ffc107', bg: '#fffde7' },
        { id: 'yeon', name: 'Ye-on', emoji: 'üòä', color: '#ff9800', bg: '#fff3e0' }
    ];

    let currentMember = null;
    let photos = [];
    const MAX_PHOTOS = 3; 

    // --- ASSETS PATH ---
    const assets = {
        logo: 'assets/logo panjang.png',
        icon: 'assets/fav.png',
        sfxShutter: 'assets/slice.mp3',
        sfxCount: 'assets/game-start.mp3'
    };

    const sfxShutter = new Audio(assets.sfxShutter);
    const sfxCount = new Audio(assets.sfxCount);
    
    // --- HELPER UNTUK LOAD GAMBAR ---
    // Ini penting supaya tidak error NaN saat render
    function loadImage(src) {
        return new Promise((resolve) => {
            const img = new Image();
            img.crossOrigin = "anonymous"; // Penting untuk menghindari Tainted Canvas
            img.onload = () => resolve(img);
            img.onerror = () => {
                console.warn("Gagal load image:", src);
                resolve(null); // Return null kalau gagal, jangan error
            };
            img.src = src;
        });
    }

    // --- INIT ---
    function init() {
        const grid = document.getElementById('grid-container');
        members.forEach(m => {
            const card = document.createElement('div');
            card.className = 'member-card';
            card.innerHTML = `<div class="mem-emoji">${m.emoji}</div><div class="mem-name">${m.name}</div>`;
            card.onclick = () => selectMember(m, card);
            grid.appendChild(card);
        });

        startCamera();
    }

    function startCamera() {
        navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } })
            .then(stream => document.getElementById('video').srcObject = stream)
            .catch(e => {
                alert("Camera error: " + e.message);
                console.error("Camera denied:", e);
            });
    }

    function selectMember(m, el) {
        currentMember = m;
        document.querySelectorAll('.member-card').forEach(c => c.classList.remove('active'));
        el.classList.add('active');
        
        // Update CSS Variable
        const root = document.documentElement.style;
        root.setProperty('--theme-color', m.color);
        root.setProperty('--theme-bg', m.bg);
        root.setProperty('--theme-accent', m.color + '44'); 

        $('#subtitle').text(`Theme: ${m.name} ${m.emoji}`);
        
        setTimeout(() => {
            $('#select-section').slideUp();
            $('#camera-section').removeClass('hidden').hide().slideDown();
        }, 300);
    }

    function resetApp() {
        $('#camera-section').slideUp();
        $('#select-section').slideDown();
    }

    // --- FOTO LOGIC ---
    async function startPhotoSession() {
        $('#camera-btns').fadeOut(); 
        photos = [];
        
        for (let i = 1; i <= MAX_PHOTOS; i++) {
            await runCountdown(3);
            captureFrame();
            
            // Efek Flash
            $('#flash').show().fadeOut(300);
            await new Promise(r => setTimeout(r, 800));
        }

        // Tampilkan loading sebelum render
        $('#loading-overlay').css('display', 'flex');
        
        // Beri waktu sebentar biar DOM siap
        setTimeout(renderStrip, 500);
    }

    function runCountdown(num) {
        return new Promise(resolve => {
            let c = num;
            $('#countdown').css('display', 'flex').text(c);
            let t = setInterval(() => {
                sfxCount.play();
                c--;
                if(c > 0) $('#countdown').text(c);
                else { clearInterval(t); $('#countdown').hide(); resolve(); }
            }, 1000);
        });
    }

    function captureFrame() {
        try {
            sfxShutter.play();
        } catch(e) { console.log("Audio play failed"); }

        const vid = document.getElementById('video');
        const c = document.createElement('canvas');
        c.width = vid.videoWidth; 
        c.height = vid.videoHeight;
        const ctx = c.getContext('2d');
        
        // Flip horizontal kalau mau seperti cermin (opsional, saat ini default kamera)
        // ctx.translate(c.width, 0); ctx.scale(-1, 1);
        
        ctx.drawImage(vid, 0, 0); 
        photos.push(c.toDataURL('image/png'));
    }

    // --- RENDER LOGIC (CORE IMPROVEMENT) ---
    async function renderStrip() {
        $('#camera-section').hide();
        $('#result-section').css('display', 'flex');

        const canvas = document.getElementById('render-canvas');
        const ctx = canvas.getContext('2d');
        const m = currentMember;

        // Load Asset Dulu (Await)
        const [logoImg, iconImg] = await Promise.all([
            loadImage(assets.logo),
            loadImage(assets.icon)
        ]);

        // Dimensi Strip
        const photoW = 400; 
        const photoH = 300;
        const pad = 40; 
        const gap = 30; 
        const footerH = 180;
        
        const stripW = photoW + (pad * 2);
        const stripH = pad + (MAX_PHOTOS * photoH) + ((MAX_PHOTOS - 1) * gap) + footerH + pad;
        const totalW = (stripW * 2) + 20; // 2 Strip
        const totalH = stripH;
        
        canvas.width = totalW; 
        canvas.height = totalH;

        // 1. Background
        const grad = ctx.createLinearGradient(0, 0, 0, totalH);
        grad.addColorStop(0, '#ffffff');
        grad.addColorStop(1, m.bg);
        ctx.fillStyle = grad;
        ctx.fillRect(0, 0, totalW, totalH);

        // 2. Pattern (Hanya jika icon berhasil diload)
        function drawPattern(offsetX) {
            for(let i=0; i<45; i++) {
                const x = offsetX + Math.random() * stripW;
                const y = Math.random() * stripH;
                const size = Math.random() * 40 + 20;
                const rot = (Math.random()-0.5) * 2;
                
                ctx.save(); 
                ctx.translate(x, y); 
                ctx.rotate(rot); 
                ctx.globalAlpha = 0.12; 
                
                // Gunakan emoji jika icon gambar gagal load
                if(iconImg && Math.random() > 0.5) {
                    ctx.drawImage(iconImg, -size/2, -size/2, size, size);
                } else {
                    ctx.font = `${size}px Arial`; 
                    ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    ctx.fillText(m.emoji, 0, 0);
                }
                ctx.restore();
            }
        }
        drawPattern(0); 
        drawPattern(stripW + 20);

        // 3. Garis Potong Tengah
        ctx.beginPath(); 
        ctx.setLineDash([15, 15]);
        ctx.moveTo(totalW/2, 0); 
        ctx.lineTo(totalW/2, totalH);
        ctx.strokeStyle = "#ccc"; 
        ctx.lineWidth = 2; 
        ctx.stroke(); 
        ctx.setLineDash([]);

        // 4. Draw Photos
        const loadedPhotos = await Promise.all(photos.map(src => loadImage(src)));

        loadedPhotos.forEach((img, idx) => {
            if(!img) return;
            const y = pad + (idx * (photoH + gap));
            
            const drawSinglePhoto = (offX) => {
                // Shadow
                ctx.fillStyle = "rgba(0,0,0,0.1)"; 
                ctx.fillRect(offX+pad+8, y+8, photoW, photoH);
                // Frame Putih
                ctx.fillStyle = "#fff"; 
                ctx.fillRect(offX+pad-10, y-10, photoW+20, photoH+20);
                // Foto
                ctx.drawImage(img, offX+pad, y, photoW, photoH);
                
                // Dekorasi Emoji Random di Sudut
                if(Math.random() > 0.3) {
                    const corner = Math.floor(Math.random()*4);
                    const sSize = 50;
                    let sx, sy;
                    // Logic posisi emoji
                    if(corner===0) { sx = offX+pad-15; sy = y-15; }
                    if(corner===1) { sx = offX+pad+photoW-35; sy = y-15; }
                    if(corner===2) { sx = offX+pad-15; sy = y+photoH-35; }
                    if(corner===3) { sx = offX+pad+photoW-35; sy = y+photoH-35; }
                    
                    ctx.font = `${sSize}px Arial`; 
                    ctx.shadowColor="rgba(0,0,0,0.2)"; ctx.shadowBlur=5;
                    ctx.fillText(m.emoji, sx, sy+sSize/2); 
                    ctx.shadowBlur=0;
                }
            };
            drawSinglePhoto(0); 
            drawSinglePhoto(stripW + 20);
        });

        // 5. Footer & Logo
        const yBase = stripH - footerH;
        
        // Safety check untuk dimensi logo
        let logoW = 200;
        let logoH = 60; // Default height jika logo gagal load
        if (logoImg && logoImg.width > 0) {
            logoH = logoW * (logoImg.height / logoImg.width);
        }

        const drawFooter = (offX) => {
            ctx.font = "bold 24px 'Fredoka One', sans-serif"; 
            ctx.fillStyle = m.color;
            ctx.textAlign = "center"; 
            ctx.fillText(`With ${m.name} ${m.emoji}`, offX + stripW/2, yBase + 50);
            
            if (logoImg) {
                ctx.drawImage(logoImg, offX + (stripW - logoW)/2, yBase + 70, logoW, logoH);
            } else {
                // Fallback text jika logo tidak ada
                ctx.font = "bold 20px Quicksand";
                ctx.fillText("H2H PHOTOBOX", offX + stripW/2, yBase + 100);
            }

            const date = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            ctx.font = "14px Quicksand"; 
            ctx.fillStyle = "#888";
            // Sesuaikan posisi tanggal tergantung logo ada atau tidak
            const dateY = logoImg ? (yBase + 70 + logoH + 25) : (yBase + 130);
            ctx.fillText(date, offX + stripW/2, dateY);
        };

        drawFooter(0); 
        drawFooter(stripW + 20);

        // 6. Set Hasil ke IMG tag
        try {
            const finalDataURL = canvas.toDataURL('image/png');
            $('#final-img').attr('src', finalDataURL);
        } catch (e) {
            console.error("Canvas Security Error:", e);
            alert("Gagal membuat gambar (Tainted Canvas). Pastikan asset gambar berasal dari domain yang sama atau gunakan local server.");
        }

        // Selesai
        $('#loading-overlay').hide();
    }

    // --- ACTION BUTTONS ---
    function downloadImage() {
        const link = document.createElement('a');
        link.download = `H2H-${currentMember ? currentMember.name : 'Photo'}-${Date.now()}.png`;
        link.href = document.getElementById('render-canvas').toDataURL();
        document.body.appendChild(link); // Penting untuk Firefox/Mobile
        link.click();
        document.body.removeChild(link);
    }

    function printImage() {
        const imgData = document.getElementById('render-canvas').toDataURL();
        const win = window.open('');
        const html = `
            <html>
                <head><title>Print Photo</title></head>
                <body style="margin:0; display:flex; justify-content:center; align-items:center; height:100vh;">
                    <img src="${imgData}" style="max-height:100%; max-width:100%;">
                    <script>
                        window.onload = function() { 
                            setTimeout(function(){ window.print(); window.close(); }, 500); 
                        };
                    <\/script>
                </body>
            </html>`;
        win.document.write(html);
        win.document.close();
    }

    // Jalankan
    init();
</script>
</body>
</html>